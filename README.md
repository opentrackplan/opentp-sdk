# @opentp/sdk

> **OpenTrackPlan** is an open-source system for managing analytics tracking plans.
> Define events in YAML → validate → generate typed SDKs → send to GA4, Snowplow, and more.
>
> [Spec](https://github.com/opentrackplan/opentp-spec) •
> [CLI](https://github.com/opentrackplan/opentp-cli) •
> [UI](https://github.com/opentrackplan/opentp-ui) •
> [SDK](https://github.com/opentrackplan/opentp-sdk)

Runtime SDK for sending typed analytics events from OpenTrackPlan.

[![npm version](https://img.shields.io/npm/v/@opentp/sdk.svg)](https://www.npmjs.com/package/@opentp/sdk)
[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](LICENSE)
[![CI](https://github.com/opentrackplan/opentp-sdk/actions/workflows/ci.yml/badge.svg)](https://github.com/opentrackplan/opentp-sdk/actions/workflows/ci.yml)
[![Bundle Size](https://img.shields.io/bundlephobia/minzip/@opentp/sdk)](https://bundlephobia.com/package/@opentp/sdk)

## Install

```bash
npm install @opentp/sdk
```

## Quick Start

```typescript
import { events } from './tracker'; // generated by opentp-cli
import { createTracker } from '@opentp/sdk';
import { ga4 } from '@opentp/sdk/ga4';

const tracker = createTracker({
  events,
  adapters: [
    ga4({ measurementId: 'G-XXXXXXX' }),
  ],
});

// Full autocomplete — wrong params = TypeScript error
tracker.auth.login({ auth_method: 'google' });
tracker.auth.logout();
```

## Adapters

### Google Analytics 4

Send events to Google Analytics 4 via gtag.js or Google Tag Manager.

```typescript
import { ga4 } from '@opentp/sdk/ga4';

const tracker = createTracker({
  events,
  adapters: [
    ga4({
      measurementId: 'G-XXXXXXX',

      // Optional: Remap event names for GA4
      eventNameMap: {
        'auth::login': 'login',
        'auth::logout': 'logout',
        'ecommerce::purchase': 'purchase',
      },

      // Optional: Rename parameters
      parameterMap: {
        auth_method: 'method',
        user_id: 'uid',
      },

      // Optional: Exclude fields from payload
      excludeFields: ['schema_vendor', 'schema_version'],

      // Optional: Push to GTM dataLayer
      pushToDataLayer: true,

      // Optional: Set GA4 user properties
      userProperties: {
        plan: 'premium',
        signup_date: '2024-01-15',
      },

      // Optional: Custom gtag function reference (default: window.gtag)
      // gtag: myGtagFn,

      // Optional: Send events even if gtag is not loaded (default: true)
      // tolerateMissingGtag: true,
    }),
  ],
});
```

**Features:**
- Automatic gtag.js integration (with fallback to dataLayer when gtag is not loaded)
- Event name remapping (e.g., `auth::login` → `login`)
- Parameter renaming and filtering
- User properties support
- GTM dataLayer integration
- Custom gtag function reference

### Snowplow

Send events to Snowplow Analytics.

#### Option A: Browser Tracker

Uses [@snowplow/browser-tracker](https://docs.snowplow.io/docs/collecting-data/collecting-from-own-applications/javascript-trackers/browser-tracker/) to send events.

```typescript
import { snowplow } from '@opentp/sdk/snowplow';

const tracker = createTracker({
  events,
  adapters: [
    snowplow({
      mode: 'browser-tracker',
      vendor: 'com.mycompany',

      // Optional: Default schema version (default: '1-0-0')
      // defaultSchemaVersion: '1-0-0',

      // Optional: Override schema versions per event
      // schemaVersionMap: { 'ecommerce::purchase': '2-0-0' },

      // Optional: Define custom contexts
      contexts: {
        user: {
          fields: ['user_id', 'user_email', 'user_plan'],
          version: '1-0-0',
        },
        session: {
          fields: ['session_id', 'session_start'],
          version: '1-0-0',
        },
      },

      // Optional: Fields to exclude from main payload
      // excludeFields: ['event_name', 'schema_vendor'],
    }),
  ],
});
```

#### Option B: HTTP Collector

Send events directly to a Snowplow collector via HTTP.

```typescript
import { snowplow } from '@opentp/sdk/snowplow';

const tracker = createTracker({
  events,
  adapters: [
    snowplow({
      mode: 'http',
      vendor: 'com.mycompany',
      collectorUrl: 'https://collector.mysite.com',
      appId: 'my-app',

      // Optional: Custom contexts
      contexts: {
        user: {
          fields: ['user_id', 'user_email'],
          version: '1-0-0',
        },
      },
    }),
  ],
});
```

**Features:**
- Self-describing events with Iglu schemas
- Custom context support (extract payload fields as Snowplow entities)
- Both browser tracker and HTTP collector modes
- Configurable schema versions (global default + per-event overrides)
- Batch sending support (HTTP mode)
- Field exclusion for internal/meta fields

### Amplitude

Send events to Amplitude Analytics via the HTTP V2 API or Amplitude Browser SDK.

#### Option A: HTTP API (default)

Works in both browser and server environments. Sends events directly to Amplitude's HTTP V2 API.

```typescript
import { amplitude } from '@opentp/sdk/amplitude';

const tracker = createTracker({
  events,
  adapters: [
    amplitude({
      apiKey: 'YOUR_AMPLITUDE_API_KEY',

      // Optional: EU data residency
      // endpoint: 'https://api.eu.amplitude.com/2/httpapi',

      // Optional: Remap event names
      eventNameMap: {
        'auth::login': 'User Logged In',
        'ecommerce::purchase': 'Purchase Completed',
      },

      // Optional: Extract payload fields as Amplitude top-level fields
      userIdField: 'user_id',       // default
      deviceIdField: 'device_id',   // default
      sessionIdField: 'session_id', // default (must be ms since epoch)

      // Optional: Map additional fields to Amplitude top-level fields
      topLevelFieldMap: {
        platform: 'platform',
        country: 'country',
      },

      // Optional: Exclude fields from event_properties
      excludeFields: ['internal_id'],

      // Optional: Static user properties sent with every event
      userProperties: {
        plan: 'premium',
        signup_date: '2024-01-15',
      },

      // Optional: Amplitude groups (Accounts feature)
      groups: {
        company: 'Acme Corp',
      },

      // Optional: Tracking plan metadata
      plan: {
        branch: 'main',
        source: 'opentp',
        version: '1.0.0',
      },

      // Optional: Deduplication (enabled by default, 7-day window)
      // insertId: false,  // set to false to disable
    }),
  ],
});
```

#### Option B: Browser SDK

Uses an existing Amplitude Browser SDK instance on the page.

```typescript
import { amplitude } from '@opentp/sdk/amplitude';

const tracker = createTracker({
  events,
  adapters: [
    amplitude({
      apiKey: 'YOUR_AMPLITUDE_API_KEY',
      mode: 'browser-sdk',

      // Optional: pass your own Amplitude instance
      // amplitudeInstance: myAmplitudeInstance,
    }),
  ],
});
```

**Features:**
- HTTP V2 API and Browser SDK modes
- Automatic field extraction (`user_id`, `device_id`, `session_id`, `app_version`)
- Custom top-level field mapping (platform, country, etc.)
- Event name remapping
- Built-in deduplication via `insert_id` (UUID, 7-day window)
- Batch sending with configurable `maxBatchSize` (HTTP mode, up to 2000)
- User properties, groups, and tracking plan metadata
- US and EU endpoint support
- `keepalive` for reliable page-unload tracking
- Configurable `minIdLength` and `onSendError` callback

### Custom Adapter

Create your own adapter for any analytics platform:

```typescript
import type { Adapter, DispatchedEvent } from '@opentp/sdk';

const myAdapter: Adapter = {
  name: 'my-platform',

  // Optional: Called once on tracker creation
  init() {
    // Initialize connections, load scripts, etc.
  },

  // Called for each event
  send(event: DispatchedEvent) {
    console.log('Event:', event.key);       // e.g. "auth::login"
    console.log('Area:', event.area);        // e.g. "auth"
    console.log('Payload:', event.payload);

    // Send to your analytics platform
    fetch('https://analytics.mysite.com/track', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        event: event.key,
        properties: event.payload,
        timestamp: event.timestamp,
      }),
    });
  },

  // Optional: Batch send (if not provided, send() is called for each event)
  async sendBatch(events: DispatchedEvent[]) {
    await fetch('https://analytics.mysite.com/track/batch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(events.map(e => ({
        event: e.key,
        properties: e.payload,
        timestamp: e.timestamp,
      }))),
    });
  },

  // Optional: Cleanup on destroy
  async destroy() {
    // Close connections, flush buffers, etc.
  },
};

const tracker = createTracker({
  events,
  adapters: [myAdapter],
});
```

## Consent Management

Built-in GDPR/CCPA consent handling. Events are automatically blocked until consent is granted.

```typescript
const tracker = createTracker({
  events,
  adapters: [ga4({ measurementId: 'G-XXX' })],
  consent: {
    // Initial consent state ('necessary' is true by default, all others false)
    defaultState: {
      analytics: false,
      marketing: false,
      functional: false,
    },

    // Map events to consent categories
    mapping: {
      'marketing::*': 'marketing',  // All marketing events need marketing consent
      'auth::*': 'functional',       // Auth events need functional consent
    },

    // Default category for events not in mapping
    defaultCategory: 'analytics',
  },
});

// Events are blocked until consent is given
tracker.auth.login({ auth_method: 'google' }); // ← silently dropped

// User accepts cookies
tracker.setConsent({ analytics: true, functional: true });

// Now events flow through
tracker.auth.login({ auth_method: 'google' }); // ← sent to GA4
```

**API:**

```typescript
// Update consent
tracker.setConsent({ analytics: true, marketing: true });

// Get current consent state
const consent = tracker.getConsent();
// { analytics: true, marketing: true, functional: false }
```

## Middleware

Transform or filter events before they reach adapters.

```typescript
import { debugMiddleware } from '@opentp/sdk';

const tracker = createTracker({
  events,
  adapters: [ga4({ measurementId: 'G-XXX' })],
  middleware: [
    // Built-in debug middleware (logs all events)
    debugMiddleware(),

    // Add session ID to every event
    (event, next) => {
      next({
        ...event,
        payload: {
          ...event.payload,
          session_id: getSessionId(),
        },
      });
    },

    // Filter out test events in production
    (event, next) => {
      if (process.env.NODE_ENV === 'production' && event.key.startsWith('test::')) {
        return; // Don't call next() to block the event
      }
      next(event);
    },

    // Add user properties
    (event, next) => {
      const user = getCurrentUser();
      next({
        ...event,
        payload: {
          ...event.payload,
          user_id: user.id,
          user_plan: user.plan,
        },
      });
    },
  ],
});
```

**Middleware signature:**

```typescript
type Middleware = (event: DispatchedEvent, next: (event: DispatchedEvent) => void) => void;
```

## Batching

Queue events and flush in batches to reduce network requests.

```typescript
const tracker = createTracker({
  events,
  adapters: [ga4({ measurementId: 'G-XXX' })],
  queue: {
    enabled: true,
    maxSize: 20,           // Flush after 20 events
    flushInterval: 5000,   // Flush every 5 seconds
  },
});

// Events are queued automatically
tracker.auth.login({ auth_method: 'google' });
tracker.auth.logout();

// Manually flush (e.g., before page unload)
window.addEventListener('beforeunload', async () => {
  await tracker.flush();
});

// Cleanup (flushes queue + destroys adapters)
await tracker.destroy();
```

**API:**

```typescript
// Flush queued events immediately
await tracker.flush();

// Cleanup (flush + destroy adapters)
await tracker.destroy();
```

## Global Metadata

Add metadata to all events:

```typescript
const tracker = createTracker({
  events,
  adapters: [ga4({ measurementId: 'G-XXX' })],
  globalMetadata: {
    app_version: '1.2.3',
    environment: 'production',
  },
});

// Update global metadata at runtime
tracker.setGlobalMetadata({
  user_plan: 'premium',
  ab_test_variant: 'B',
});
```

## Error Handling

Handle errors from adapters:

```typescript
const tracker = createTracker({
  events,
  adapters: [ga4({ measurementId: 'G-XXX' })],
  onError(error, event) {
    console.error('Failed to send event:', event?.key, error);

    // Report to error tracking service
    Sentry.captureException(error, {
      extra: { event: event?.key, payload: event?.payload },
    });
  },
});
```

## API Reference

### `createTracker(config)`

Creates a tracker instance.

**Config:**

```typescript
interface TrackerConfig<TEvents extends EventsMap = EventsMap> {
  events: TEvents;                   // Generated by opentp-cli
  adapters: Adapter[];               // Analytics adapters
  middleware?: Middleware[];          // Event transformation pipeline
  consent?: ConsentConfig;           // Consent management
  queue?: QueueConfig;               // Event batching
  globalMetadata?: Record<string, unknown>; // Metadata added to all events
  onError?: (error: Error, event?: DispatchedEvent) => void; // Error handler
}
```

### `DispatchedEvent`

```typescript
interface DispatchedEvent {
  key: string;                         // Event key, e.g. "auth::login"
  area: string;                        // Area name, e.g. "auth"
  eventName: string;                   // Event name, e.g. "login"
  payload: Record<string, unknown>;    // Full merged payload (constants + params)
  timestamp: number;                   // When the event was dispatched
  metadata: Record<string, unknown>;   // Metadata added by middleware
}
```

### `Adapter`

```typescript
interface Adapter {
  name: string;
  init?(): void | Promise<void>;
  send(event: DispatchedEvent): void | Promise<void>;
  sendBatch?(events: DispatchedEvent[]): void | Promise<void>;
  destroy?(): void | Promise<void>;
}
```

### `Middleware`

```typescript
type Middleware = (event: DispatchedEvent, next: (event: DispatchedEvent) => void) => void;
```

### `ConsentCategory`

```typescript
type ConsentCategory = 'analytics' | 'marketing' | 'functional' | 'necessary';
```

### `ConsentConfig`

```typescript
interface ConsentConfig {
  defaultState?: ConsentState;                   // Initial consent state (necessary: true by default)
  mapping?: Record<string, ConsentCategory>;     // Event pattern → category
  defaultCategory?: ConsentCategory;             // Default category (default: 'analytics')
}
```

### `QueueConfig`

```typescript
interface QueueConfig {
  enabled?: boolean;        // Enable batching (default: false)
  maxSize?: number;         // Flush after N events (default: 10)
  flushInterval?: number;   // Flush every N ms (default: 5000)
}
```

### Tracker Methods

```typescript
type Tracker<TEvents> = TrackerMethods<TEvents> & TrackerControls;

// Auto-generated event methods based on your tracking plan
type TrackerMethods<TEvents> = {
  [Area in keyof TEvents]: {
    [Event in keyof TEvents[Area]]: (params: Params) => void;
  };
};

interface TrackerControls {
  // Consent
  setConsent(state: Partial<ConsentState>): void;
  getConsent(): ConsentState;

  // Metadata
  setGlobalMetadata(metadata: Record<string, unknown>): void;

  // Queue
  flush(): Promise<void>;
  destroy(): Promise<void>;
}
```

## Development

```bash
# Install dependencies
npm install

# Build
npm run build

# Run tests
npm run test

# Watch mode
npm run dev

# Lint
npm run lint
npm run lint:fix
```

## License

Apache-2.0
